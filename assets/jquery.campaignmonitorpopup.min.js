!function(e){var o=function(o,i){var a={CookieName:"CampaignMonitorPopup",SessionCookieName:"CampaignMonitorPopupSession",Visits:[],Delay:1e4,PageViewNumber:1,CloseSelectors:[],ShowSelectors:[],ShowPopupOnCurrentPage:!1,CallBackOnSuccess:null,CallBackOnError:null,CallBackOnDisplayed:null,CallBackOnClosed:null,CallBackOnFormSubmitted:null,RedirectOnSubmitSuccess:!1,InnerWrapper:".modal",SignupKey:"signup",HidePopupOnSuccess:!0,ShowAlertMessage:!0};e.extend(a,i||{});var n={Status:"",PageView:0,Visits:0,PopupAlreadyShownOnVisit:[]},t={NotSubmitted:"NotSubmitted",HasSubmitted:"HasSubmitted",ShowOnNextVisit:"ShowOnNextVisit",ErrorInSubmitted:"ErrorInSubmitted"},s=o,r=e("form",s),u={Initialize:function(){this.Hide(!1),this.ReadAndSetupCookieValues(),this.InitCustomEvents()},InitCustomEvents:function(){e(a.InnerWrapper,s).append('<a class="popupClose"></a>');for(var o=0;o<a.CloseSelectors.length;o++){var i=e(a.CloseSelectors[o]);i.click(function(e){return u.Hide(!0),e.stopPropagation(),!1})}for(var o=0;o<a.ShowSelectors.length;o++){var i=e(a.ShowSelectors[o]);i.click(function(e){return u.Show(!0),e.stopPropagation(),!1})}e(document).keydown(function(e){keycode=null==e?event.keyCode:e.which,27==keycode&&u.Hide(!0)}),s.click(function(){e(this).hasClass("modalize")&&u.Hide(!0)}),e(a.InnerWrapper,s).click(function(e){e.stopPropagation()})},Hide:function(e){s.removeClass("modalize"),a.CallBackOnClosed&&a.CallBackOnClosed(e&&!u.UserHasSignedUp)},ReadAndSetupCookieValues:function(){var e=T3Core.CookieManager.ReadCookie(a.SessionCookieName),o=this.ReadJsonFromCookie(a.CookieName);if(null==o&&null==e)T3Core.CookieManager.CreateCookie(a.SessionCookieName,1),this.SaveJsonToCookie(a.CookieName,t.ShowOnNextVisit,1,1,"",30),o=this.ReadJsonFromCookie(a.CookieName);else if(null==o&&(this.SaveJsonToCookie(a.CookieName,t.ShowOnNextVisit,1,1,"",30),o=this.ReadJsonFromCookie(a.CookieName)),null==e){var i=o,n=i.Visits+1,s=i.PageView;T3Core.CookieManager.CreateCookie(a.SessionCookieName,n),i.Status==t.ShowOnNextVisit&&this.SaveJsonToCookie(a.CookieName,t.ShowOnNextVisit,s,n,"",30)}o.Status==t.ShowOnNextVisit&&a.ShowPopupOnCurrentPage&&u.ProcessCookiesValuesAndShowPopupIfNeeded()},SaveJsonToCookie:function(e,o,i,a,t,s){n.Status=o,n.PageView=i,n.Visits=a,""!=t&&n.PopupAlreadyShownOnVisit.push(t),T3Core.CookieManager.CreateCookie(e,JSON.stringify(n),s)},ReadJsonFromCookie:function(e){var o=T3Core.CookieManager.ReadCookie(e),i=null;if(null!=o)try{i=JSON.parse(o)}catch(a){o.indexOf(t.HasSubmitted)!=-1&&(u.SaveJsonToCookie(e,t.HasSubmitted,"","","",365),i=JSON.parse(T3Core.CookieManager.ReadCookie(e)))}return i},ProcessCookiesValuesAndShowPopupIfNeeded:function(){var o=this.ReadJsonFromCookie(a.CookieName),i={PageView:0,Visits:0,NeedToShowPopupOnCurrentVisit:!1,NeedToShowPopupOnCurrentPageView:!1,PopupAlreadyShown:!1,ShowPopup:!1};if(i.PageView=parseInt(o.PageView),i.Visits=parseInt(o.Visits),o.PopupAlreadyShownOnVisit.length>0&&(i.PopupAlreadyShown=e.inArray(i.Visits,o.PopupAlreadyShownOnVisit)!=-1),i.NeedToShowPopupOnCurrentVisit=e.inArray(i.Visits,a.Visits)!=-1&&!i.PopupAlreadyShown,i.NeedToShowPopupOnCurrentPageView=i.PageView==a.PageViewNumber,i.NeedToShowPopupOnCurrentVisit&&i.PageView<=a.PageViewNumber)if(i.NeedToShowPopupOnCurrentPageView)this.SaveJsonToCookie(a.CookieName,t.ShowOnNextVisit,1,i.Visits,i.Visits,30);else{var n=i.PageView+1;this.SaveJsonToCookie(a.CookieName,t.ShowOnNextVisit,n,i.Visits,"",30)}i.Visits>a.Visits[a.Visits.length-1],i.ShowPopup=i.NeedToShowPopupOnCurrentVisit&&i.NeedToShowPopupOnCurrentPageView,i.ShowPopup&&this.Show(!1)},Show:function(e){var o=e?1e3:a.Delay;setTimeout(function(){s.addClass("modalize"),a.CallBackOnDisplayed&&a.CallBackOnDisplayed(),u.InitBValidator(),u.InitAjaxSubmit()},o)},InitBValidator:function(){var e={singleError:!0};r.bValidator(e)},InitAjaxSubmit:function(){r.submit(function(o){var i=this.action+"?callback=?",n=r.serialize();return e.getJSON(i,n,u.AjaxFormSubmitCallBack),a.CallBackOnFormSubmitted&&a.CallBackOnFormSubmitted(),o.stopPropagation(),!1})},AjaxFormSubmitCallBack:function(e){if(200===e.Status){u.UserHasSignedUp=!0;e.Message;u.SaveJsonToCookie(a.CookieName,t.HasSubmitted,"","","",365),a.RedirectOnSubmitSuccess&&e.RedirectUrl?(a.CallBackOnSuccess&&a.CallBackOnSuccess(e,s),window.location=e.RedirectUrl):(a.CallBackOnSuccess&&a.CallBackOnSuccess(e,s),a.ShowAlertMessage,a.HidePopupOnSuccess&&u.Hide(!1))}else a.CallBackOnError&&a.CallBackOnError(e)},UserHasSignedUp:!1};!function(){var e=T3Core.GetQueryStringByKey(a.SignupKey);""!=e?1==e&&(u.Initialize(),u.Show()):u.Initialize()}()};e.fn.CampaignMonitorPopup=function(e){return new o(this,e)}}(jQuery);